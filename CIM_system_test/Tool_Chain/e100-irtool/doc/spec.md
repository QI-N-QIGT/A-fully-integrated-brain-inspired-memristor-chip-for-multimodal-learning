# E100 IR 格式规范 v1

## 1. 总体设计原则

IR 是对 E100 项目中核心数据结构的描述和格式定义，用于指导各个软件工具进行数据管理、数据校验、数据转换和数据交换。

本文档定义了 IR 核心的数据结构和数据格式，用户可在此基础上进行扩展和增加自定义内容，不同软件工具对 IR 的扩展**必须**与本文档和核心模块定义的数据语义、数据结构和格式兼容。

本文档仅涉及 `e100_irtool.core` 中所定义的数据类型和格式。

算子定义请参见 `e100_irtool.ops` 代码和文档。

设备定义请参见 `e100_irtool.devices` 代码和文档。


## 2. 数据文件格式说明

IR 的交换数据格式为 JSON 或 YAML 格式，在 python 程序中对应 dict 对象，三者之间可任意转换而不会损失任何语义信息。

核心模块 `e100_irtool` 中定义了以下函数进行 IR 的数据导入和导出：

- **load_json**(data=None, file=None, cls=None) 导入 JSON/YAML 格式数据或文件，转换为 dict 或 cls 对象；
- **load_ir**(data=None, file=None) 导入 IR 数据或文件，转换为 BaseIR 类型对象；
- **dump_json**(obj, file=None) 将对象导出为 JSON/YAML 格式数据或文件；
- **BaseIR.dump**(file=None) 将 IR 对象导出为 JSON/YAML 格式数据或文件；

**注意**：
- 使用 YAML 格式需要安装 `pyyaml` 软件包；
- 本系统不支持 YAML 的扩展格式和注释；


## 3. 核心数据类型

### 3.1 算子（Operator/Op)

“算子”定义了一个具体的计算函数，有明确的名称、参数定义、输入数据数量和类型、输出数据数量和类型。当参数确定后，算子的数学行为是确定的。

算子支持范围是由算子注册机制确定的，`e100_irtool.ops` 中包含了一部分已注册和支持的算子实现，用户也可以注册新的算子。

`e100_irtool` 中提供了以下函数构建算子：

- **make_op**(op_id, \*\*kwargs) 构建一个算子对象，算子类型由 `op_id` 确定，算子属性由其他参数进行定义；

### 3.2 层（Layer）

“层”是用户定义的算法图的构建单元，封装了一个算子、一组算子图或数据的输入输出操作。层在整个 IR 中呈现树状结构，并通过输入输出定义构建完整的计算流程图。

层的结构完全由用户设计和定义，用户需要保证计算流程图的完整和完备性。

IR 中通常用层的名称代表层的输出。

`e100_irtool` 中提供了以下函数构建层实例：

- **make_layer**(op=None, inputs=None, outputs=None, layers=None) 新建一个层对象，封装算子或算子图，指定输入和输出；

### 3.3 设备（Device）

“设备”定义了一个执行运算的软件或硬件单元。设备中可包含子设备，从而构建树状的运算软硬件平台。设备的类型和参数由设备类型注册机制进行管理，用户可自行定义和扩展新的设备类型。

设备的作用主要是为算子-设备映射提供目标和名称索引，和为特定 IR 工具提供数据属性注释。

`e100_irtool` 中提供了以下函数构建设备实例：

- **make_device**(kind, number=None, devices=None) 新建一个设备对象，可指定数量和子设备；

### 3.4 数据集和索引

IR 中的层和设备都被包含在数据集中进行管理，数据集是由多级 dict 类构建的树状数据结构，每一级 dict 的主键为对象名称，值为对象实例。

当在 IR 内部引用另一个对象时，遵循如下规则：

1. 同级别同类对象可直接引用对象名称；
2. 不同级别或不同类对象必须引用对象完整路径，用 '.' 将各级名称连接起来；
3. 当需要指定对象的数量下标时，用 ':' 将对象名称和下标连接起来；
